#!/usr/bin/env zsh
set -e
CURRENT_DIR=$(cd "$(dirname "${0:A}")" && pwd)  # https://tinyurl.com/y5kkhfrd, https://tinyurl.com/ydxeax8k
BASEDIR="$(cd $CURRENT_DIR/.. && pwd)"
PRIVATE_BASEDIR="${BASEDIR}-private"
source "${BASEDIR}/utils/output.zsh"
source "${BASEDIR}/utils/utils.zsh"
source "${BASEDIR}/utils/pkg_utils.zsh"

# SETUP
##############################

# check if dotfiles is installed to TARGET_DIR
# note: choose to not move it into TARGET_DIR automatically, since it will be synced via dropbox
TARGET_DIR="$HOME/dropbox/dev/dotfiles"
if [[ -d $TARGET_DIR && -x $TARGET_DIR/bin/install && $TARGET_DIR:l != $BASEDIR:l ]]; then
	if yes_no "Running dotfiles from ${BASEDIR}. Would you like to delete this copy and switch to ${TARGET_DIR}?"; then
		rmtrash $BASEDIR
		$TARGET_DIR/bin/install $*
		exit 0
	fi
fi

if ! which brew > /dev/null; then
  action "Installing brew \U1F37A"
  if ! run "/usr/bin/ruby -e \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\""; then
    error "unable to install brew, script $0 abort!"
    exit 1
  fi
fi

# PACKAGES
##############################

section "syncing packages"

$BASEDIR/bin/pkg -t brew -I -u -F -f "${BASEDIR}/packages/Brewfile"
$BASEDIR/bin/pkg -t pip  -I -u -F -f "${BASEDIR}/packages/pip_packages.txt"

end_section "syncing packages"

# LINKING
##############################
$BASEDIR/bin/link $*

# PRIVATE / LOCAL
##############################
$BASEDIR/bin/private $*
$BASEDIR/bin/local $*

# MISC
##############################
$BASEDIR/bin/misc $*

echo "\n\U1F38A  Done! \U1F389"
