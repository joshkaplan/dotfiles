#!/usr/bin/env zsh
set -e
BASEDIR=$(cd "$(dirname "${0:A}")/.." && pwd)
source "${BASEDIR}/utils/utils.zsh"
source "${BASEDIR}/utils/pkg_utils.zsh"

# Process and validate args
zparseopts -D -E -- t:=PKG_TYPE f:=FILE u=UPGRADE_MODE i=INTERACTIVE_MODE h=HELP_MODE
if [[ $HELP_MODE ]]; then 
	echo "By default, updates packaage managers and checks pacakge diffs"
	echo "\nUsage:"
	echo "    pkg_sync -f file -t type [-i|-u]"
	echo "\nOptions:"
	echo "    -i  interactive mode"
	echo "    -u  upgrade local packages"
	return 0
fi
if [[ -n $* ]]; then 
	error "Unknown options $*"
	return 1
fi
PKG_TYPE=$PKG_TYPE[2]
FILE=$FILE[2]
FILENAME="${FILE##*/}"
case "$PKG_TYPE" in
	brew)
		EMOJI="\U1F37A"
		;;
	pip)
		EMOJI="\U1F40D"
		;;
	*)
		error "unknown package manager $PKG_TYPE"
		return 1
esac
if [[ ! -f $FILE ]]; then
	error "Invalid file '${FILE}'"
	return 1
fi

# Update package manager (yes by default)
if [[ -z $INTERACTIVE_MODE ]] || yes_no "Would you like to update ${PKG_TYPE} (recommended)?"; then 
	action "Updating ${PKG_TYPE} ${EMOJI}"
	pkg_update $PKG_TYPE
fi

# Check outdated / upgrade
if [[ -n $INTERACTIVE_MODE ]]; then
	action "Checking outdated ${PKG_TYPE} packages ${EMOJI}"
	pkg_outdated $PKG_TYPE
fi
if [[ -n $UPGRADE_MODE ]] || [[ -n $INTERACTIVE_MODE ]] && yes_no "Would you like to upgrade these ${PKG_TYPE} packages?"; then 
	action "Upgrading ${PKG_TYPE} ${EMOJI}"
	pkg_upgrade $PKG_TYPE
fi

# Check if packages from file are installed
pkg_check_and_install -t $PKG_TYPE -f $FILE -e $EMOJI

# Check diff between local and file (INTERACTIVE MODE)
if [[ -n $INTERACTIVE_MODE ]]; then 
	action "Checking if local packages are in sync with ${FILENAME} ${EMOJI}"
	if ! pkg_check_diff $PKG_TYPE $FILE; then
		if yes_no "Save local packages (left) to ${FILENAME} (right)?"; then
			action "Saving packages"
			pkg_save $PKG_TYPE $FILE
		fi
	fi
fi
